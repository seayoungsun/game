# 🏗️ 架构概念：多实例部署、负载均衡、分布式架构

本文档详细解释这三个概念的区别、关系和包含层次。

---

## 📊 概念层次关系

```
分布式架构（最广泛）
    ↓
负载均衡（实现方式之一）
    ↓
多实例部署（基础实现）
```

**关系：**
- **分布式架构** 是最大的概念，包含多种实现方式
- **负载均衡** 是实现分布式架构的一种方式
- **多实例部署** 是负载均衡的基础，也是分布式架构的基础

---

## 1️⃣ 多实例部署（Multi-Instance Deployment）

### 定义

**多实例部署** 是指同一个应用在多个服务器或容器中运行多个实例。

### 特点

- ✅ **最简单**：只需要运行多个相同的应用实例
- ✅ **无状态**：每个实例独立运行，不共享内存状态
- ✅ **水平扩展**：通过增加实例数量来提升性能

### 示例

```bash
# 在同一台服务器上运行多个实例（不同端口）
./game-server --port=8081 --instance=1
./game-server --port=8082 --instance=2
./game-server --port=8083 --instance=3

# 或在多台服务器上运行
服务器1: ./game-server --port=8081
服务器2: ./game-server --port=8081
服务器3: ./game-server --port=8081
```

### 架构图

```
客户端
  ↓
[实例1] [实例2] [实例3]  ← 多个独立实例
  ↓      ↓      ↓
各自管理自己的连接和状态
```

### 问题

- ❌ **无路由**：客户端不知道连接哪个实例
- ❌ **无协调**：实例之间无法通信
- ❌ **状态隔离**：每个实例的状态独立，无法共享

---

## 2️⃣ 负载均衡（Load Balancing）

### 定义

**负载均衡** 是在多实例部署的基础上，添加一个**负载均衡器**来分发请求到不同的实例。

### 特点

- ✅ **请求分发**：自动将请求分发到不同实例
- ✅ **高可用**：某个实例故障时，可以路由到其他实例
- ✅ **性能提升**：通过分散负载提升整体性能

### 负载均衡策略

1. **轮询（Round Robin）**
   ```
   请求1 → 实例1
   请求2 → 实例2
   请求3 → 实例3
   请求4 → 实例1
   ```

2. **最少连接（Least Connections）**
   ```
   请求 → 当前连接数最少的实例
   ```

3. **IP 哈希（IP Hash）**
   ```
   相同 IP 的请求 → 同一个实例（会话保持）
   ```

4. **加权轮询（Weighted Round Robin）**
   ```
   根据实例性能分配不同权重
   ```

### 架构图

```
客户端
  ↓
[负载均衡器] ← Nginx / HAProxy / 云负载均衡器
  ↓    ↓    ↓
[实例1] [实例2] [实例3]
```

### 示例

```nginx
# Nginx 配置
upstream game_servers {
    server 10.0.0.1:8081;
    server 10.0.0.2:8081;
    server 10.0.0.3:8081;
}

server {
    listen 80;
    location / {
        proxy_pass http://game_servers;
    }
}
```

### 问题

- ❌ **状态共享**：实例之间仍然无法共享状态
- ❌ **跨实例通信**：实例之间无法直接通信
- ❌ **会话保持**：WebSocket 需要会话保持

---

## 3️⃣ 分布式架构（Distributed Architecture）

### 定义

**分布式架构** 是一个更广泛的概念，指将系统拆分成多个独立的组件，这些组件可以部署在不同的服务器上，通过网络通信协作。

### 特点

- ✅ **组件解耦**：系统拆分成多个独立服务
- ✅ **独立扩展**：每个组件可以独立扩展
- ✅ **故障隔离**：某个组件故障不影响其他组件
- ✅ **技术多样性**：不同组件可以使用不同技术栈

### 分布式架构模式

#### 1. 微服务架构（Microservices）

```
[API 网关]
    ↓
[用户服务] [房间服务] [游戏服务] [支付服务]
    ↓         ↓         ↓         ↓
[数据库]  [Redis]  [消息队列] [外部API]
```

#### 2. 服务网格（Service Mesh）

```
[服务A] ←→ [服务网格] ←→ [服务B]
              ↓
        [服务发现、负载均衡、监控]
```

#### 3. 事件驱动架构（Event-Driven）

```
[服务A] → [消息队列] → [服务B]
              ↓
          [服务C]
```

### 架构图

```
客户端
  ↓
[API 网关 / 负载均衡器]
  ↓
[服务发现] ← 注册中心（Redis/Consul/Etcd）
  ↓
[服务A] ←→ [消息队列] ←→ [服务B]
  ↓                        ↓
[数据库A]              [数据库B]
```

### 包含关系

**分布式架构包含：**
- ✅ 多实例部署
- ✅ 负载均衡
- ✅ 服务发现
- ✅ 配置中心
- ✅ 消息队列
- ✅ 分布式存储
- ✅ 分布式锁
- ✅ 监控和日志

---

## 🔄 三者关系详解

### 关系图

```
┌─────────────────────────────────────┐
│     分布式架构（Distributed）        │
│                                     │
│  ┌───────────────────────────────┐ │
│  │   负载均衡（Load Balancing）   │ │
│  │                               │ │
│  │  ┌─────────────────────────┐ │ │
│  │  │ 多实例部署（Multi-      │ │ │
│  │  │ Instance Deployment）   │ │ │
│  │  └─────────────────────────┘ │ │
│  │                               │ │
│  │  + 服务发现                   │ │
│  │  + 配置中心                   │ │
│  │  + 消息队列                   │ │
│  │  + 分布式存储                 │ │
│  └───────────────────────────────┘ │
│                                     │
│  + 微服务拆分                       │
│  + 服务网格                         │
│  + 事件驱动                         │
└─────────────────────────────────────┘
```

### 包含关系

1. **多实例部署** ⊂ **负载均衡**
   - 负载均衡需要多实例部署作为基础
   - 但多实例部署不一定需要负载均衡

2. **负载均衡** ⊂ **分布式架构**
   - 分布式架构通常使用负载均衡
   - 但分布式架构还包含更多内容

3. **多实例部署** ⊂ **分布式架构**
   - 分布式架构通常需要多实例部署
   - 但分布式架构还包含更多内容

---

## 📋 实际项目中的演进

### 阶段1：单实例（当前状态）

```
客户端 → [游戏服务器]（单实例）
```

**特点：**
- 简单直接
- 性能受限于单机
- 单点故障

### 阶段2：多实例部署

```
客户端 → [实例1] [实例2] [实例3]
```

**问题：**
- 客户端不知道连接哪个
- 需要手动指定端口

### 阶段3：负载均衡

```
客户端 → [负载均衡器] → [实例1] [实例2] [实例3]
```

**改进：**
- 自动分发请求
- 高可用
- 但实例之间无法通信

### 阶段4：分布式架构（完整方案）

```
客户端
  ↓
[负载均衡器]
  ↓
[服务发现] ← Redis/Consul
  ↓
[游戏服务器实例1] ←→ [Redis Pub/Sub] ←→ [游戏服务器实例2]
  ↓                                              ↓
[本地 Hub]                                    [本地 Hub]
  ↓                                              ↓
[共享状态] ← Redis ← [共享状态]
```

**完整功能：**
- ✅ 负载均衡
- ✅ 服务发现
- ✅ 跨实例通信
- ✅ 状态共享
- ✅ 高可用

---

## 🎯 你的项目当前状态

### 当前架构

```
单实例架构
├── API 服务（apps/api）
└── 游戏服务器（apps/game-server）
    └── Hub（内存管理所有连接）
```

### 改造方案对比

#### 方案1：多实例部署（最简单）

```bash
# 运行多个实例
./game-server --port=8081
./game-server --port=8082
./game-server --port=8083
```

**问题：**
- 客户端需要知道所有端口
- 无法自动分发
- 实例之间无法通信

#### 方案2：负载均衡（推荐第一步）

```
客户端 → Nginx → [实例1] [实例2] [实例3]
```

**改进：**
- 自动分发请求
- 高可用
- 但房间内玩家可能在不同实例，无法通信

#### 方案3：分布式架构（完整方案）

```
客户端
  ↓
Nginx（负载均衡）
  ↓
[服务发现] ← Redis
  ↓
[实例1] ←→ [Redis Pub/Sub] ←→ [实例2]
  ↓                              ↓
[Hub]                          [Hub]
  ↓                              ↓
[房间映射] ← Redis → [房间映射]
```

**完整功能：**
- ✅ 负载均衡
- ✅ 服务发现
- ✅ 跨实例通信
- ✅ 状态共享

---

## 📊 对比表格

| 特性 | 多实例部署 | 负载均衡 | 分布式架构 |
|------|-----------|---------|-----------|
| **复杂度** | ⭐ 简单 | ⭐⭐ 中等 | ⭐⭐⭐ 复杂 |
| **请求分发** | ❌ 手动 | ✅ 自动 | ✅ 自动 |
| **服务发现** | ❌ 无 | ❌ 无 | ✅ 有 |
| **跨实例通信** | ❌ 无 | ❌ 无 | ✅ 有 |
| **状态共享** | ❌ 无 | ❌ 无 | ✅ 有 |
| **高可用** | ⚠️ 部分 | ✅ 是 | ✅ 是 |
| **扩展性** | ⚠️ 有限 | ✅ 好 | ✅ 优秀 |
| **适用场景** | 测试/小规模 | 中等规模 | 大规模/生产 |

---

## 🚀 建议的演进路径

### 阶段1：多实例部署（测试）

```bash
# 先运行多个实例，验证功能
./game-server --port=8081
./game-server --port=8082
```

### 阶段2：负载均衡（快速提升）

```nginx
# 配置 Nginx 负载均衡
upstream game_servers {
    server localhost:8081;
    server localhost:8082;
}
```

### 阶段3：分布式架构（完整方案）

```go
// 添加服务发现
// 添加跨实例通信
// 添加状态共享
```

---

## 💡 总结

1. **多实例部署** = 运行多个相同的应用实例
2. **负载均衡** = 多实例部署 + 请求分发器
3. **分布式架构** = 负载均衡 + 服务发现 + 跨实例通信 + 状态共享 + 更多

**关系：**
- 多实例部署是基础
- 负载均衡是多实例部署的增强
- 分布式架构是完整的解决方案

**你的项目：**
- 当前：单实例
- 下一步：多实例部署 + 负载均衡
- 最终：完整的分布式架构（如文档中的方案）

---

**相关文档：**
- [负载均衡改造方案](./load_balancing_guide.md)

